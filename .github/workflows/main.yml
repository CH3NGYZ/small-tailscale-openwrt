name: Sync and Build Tailscale

on:
  schedule:
    - cron: '10 23 * * *'
  workflow_dispatch:
    inputs:
      versions:
        description: 'Tailscale versions (e.g. 1.76.1-1.78.0,1.79.2 â€” leave empty for latest)'
        required: false
  watch:
    types: [started]

permissions:
  contents: write

env:
  REPO_OFFICIAL: 'tailscale/tailscale'
  BUILD_PLATFORMS: 'amd64 386 arm arm64 mips mipsle mips64 mips64le'
  GO_BUILD_FLAGS: "-tags ts_include_cli -ldflags='-s -w'"

jobs:
  prepare_versions:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
    steps:
      - name: Fetch all tags from official repo
        id: fetch_tags
        run: |
          curl -s "https://api.github.com/repos/${{ env.REPO_OFFICIAL }}/tags?per_page=1000" | \
            jq -r '.[].name' | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' > all_tags.txt

      - name: Parse user input and build matrix
        id: set_matrix
        run: |
          echo "===> è¾“å…¥å‚æ•°: ${{ github.event.inputs.versions }}"
          input="${{ github.event.inputs.versions }}"

          if [ -z "$input" ]; then
            tag=$(head -n1 all_tags.txt)
            tag=${tag#v}  # å»é™¤å‰ç¼€ vï¼ˆå¦‚æœæœ‰ï¼‰
            echo "æœªæä¾›è¾“å…¥ï¼Œé»˜è®¤å–ç¬¬ä¸€ä¸ª tag: $tag"
            echo "matrix=$(jq -cn --arg v "$tag" '[ $v ]')" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "===> å¼€å§‹è§£æç‰ˆæœ¬èŒƒå›´ï¼š$input"

          declare -A versions
          IFS=',' read -ra parts <<< "$input"
          for part in "${parts[@]}"; do
            if [[ "$part" == *"-"* ]]; then
              start=${part%-*}
              end=${part#*-}
              echo "  å‘ç°èŒƒå›´: $start åˆ° $end"
              matched=$(sed 's/^v//' all_tags.txt | sort -V | awk -v s="$start" -v e="$end" '$0 >= s && $0 <= e')
              echo "    åŒ¹é…ç»“æœï¼š$(echo "$matched" | xargs)"
              for v in $matched; do
                versions["v$v"]=1
              done
            else
              echo "  å‘ç°å•ä¸€ç‰ˆæœ¬: $part"
              versions["v$part"]=1
            fi
          done

          echo "===> æ”¶é›†åˆ°ç‰ˆæœ¬ï¼ˆæœªæ’åºï¼‰:"
          for v in "${!versions[@]}"; do
            echo "  - $v"
          done

          all_versions_sorted=$(for v in "${!versions[@]}"; do echo "$v" | sed 's/^v//'; done | sort -V)
          echo "===> æ’åºåç‰ˆæœ¬:"
          echo "$all_versions_sorted"

          jq_array=$(printf '%s\n' $all_versions_sorted | jq -R . | jq -s .)
          echo "===> ç”Ÿæˆ matrix:"
          echo "$jq_array" | jq -c
          echo "matrix=$(echo "$jq_array" | jq -c)" >> "$GITHUB_OUTPUT"

  build_and_release:
    needs: prepare_versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ${{ fromJson(needs.prepare_versions.outputs.matrix) }}
      fail-fast: true
      max-parallel: 16
    env:
      TAG: v${{ matrix.version }}
    steps:
      - name: Check if release exists
        id: check_release
        run: |
          REPO="${{ github.repository }}"
          TAG="v${{ matrix.version }}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          # æŸ¥è¯¢ Release
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG")

          if [ "$RESPONSE" -eq 200 ]; then
            echo "Release $TAG already exists"
            echo "skip=true" >> $GITHUB_ENV
          else
            echo "Release $TAG does not exist"
            echo "skip=false" >> $GITHUB_ENV
          fi

      - name: Checkout Tailscale source
        uses: actions/checkout@v4
        if: env.skip != 'true'
        with:
          repository: ${{ env.REPO_OFFICIAL }}
          ref: ${{ env.TAG }}

      - name: Setup Go environment
        uses: actions/setup-go@v5
        if: env.skip != 'true'
        with:
          go-version: 'stable'

      - name: Install latest UPX
        if: env.skip != 'true'
        run: |
          set -e
          LATEST_UPX=$(curl -s https://api.github.com/repos/upx/upx/releases/latest | grep -oP '"tag_name": "v\K[0-9.]+' | head -n1)
          echo "Latest UPX version: $LATEST_UPX"
          curl -LO "https://github.com/upx/upx/releases/download/v${LATEST_UPX}/upx-${LATEST_UPX}-amd64_linux.tar.xz"
          tar -xf "upx-${LATEST_UPX}-amd64_linux.tar.xz"
          sudo cp "upx-${LATEST_UPX}-amd64_linux/upx" /usr/local/bin/
          upx --version

      - name: Build optimized binaries
        if: env.skip != 'true'
        run: |
          echo "${{ env.TAG }}" > version.txt
          mkdir -p ./build
          for arch in ${{ env.BUILD_PLATFORMS }}; do
            echo "Building for $arch..."
            binary_name="./build/tailscaled-linux-${arch}.build"

            export CGO_ENABLED=0
            export GOOS=linux
            export GOARCH=$arch

            case "$arch" in
              mips|mipsle)
                export GOMIPS=softfloat
                ;;
            esac

            go build -o "$binary_name" ${{ env.GO_BUILD_FLAGS }} ./cmd/tailscaled

            if [ ! -f "$binary_name" ]; then
              echo "âŒ  ç¼–è¯‘å¤±è´¥: $binary_name ä¸å­˜åœ¨"
              exit 1
            fi
          done

      - name: Compress binaries
        if: env.skip != 'true'
        run: |
          mkdir -p ./upx_compress
          for arch in ${{ env.BUILD_PLATFORMS }}; do
            binary_name="./build/tailscaled-linux-${arch}.build"
            compressed_name="./upx_compress/tailscaled-linux-${arch}"

            case "$arch" in
              mips64|mips64le)
                echo "âš ï¸  è·³è¿‡ $arch çš„ UPX å‹ç¼©"
                cp "$binary_name" "$compressed_name"
                ;;
              *)
                if [[ -f "$binary_name" ]]; then
                  upx --lzma --best --no-progress "$binary_name" -o "$compressed_name"
                else
                  echo "âŒ  ç¼–è¯‘å¤±è´¥: $binary_name ä¸å­˜åœ¨"
                fi
                ;;
            esac
          done

      - name: Generate checksums
        if: env.skip != 'true'
        run: |
          sha256sum ./build/tailscaled-* > SHA256SUMS.txt
          md5sum ./build/tailscaled-* > MD5SUMS.txt
          sha256sum ./upx_compress/tailscaled-* >> SHA256SUMS.txt
          md5sum ./upx_compress/tailscaled-* >> MD5SUMS.txt

          sed -i 's|./build/||g' SHA256SUMS.txt
          sed -i 's|./build/||g' MD5SUMS.txt
          sed -i 's|./upx_compress/||g' SHA256SUMS.txt
          sed -i 's|./upx_compress/||g' MD5SUMS.txt
          sed -i 's/  */ /g' SHA256SUMS.txt
          sed -i 's/  */ /g' MD5SUMS.txt

          cat SHA256SUMS.txt
          cat MD5SUMS.txt

      - name: Wait previous version release
        if: env.skip != 'true'
        run: |
          echo "=== å½“å‰ Matrix ç‰ˆæœ¬åˆ—è¡¨ ==="
          echo '${{ needs.prepare_versions.outputs.matrix }}' | jq -r '.[]'

          # è§£æ matrix ä¸º bash æ•°ç»„
          readarray -t matrix_versions < <(echo '${{ needs.prepare_versions.outputs.matrix }}' | jq -r '.[]')

          # æ‰¾å‡ºå½“å‰ç‰ˆæœ¬åœ¨ matrix ä¸­çš„å‰ä¸€ä¸ªç‰ˆæœ¬
          prev_version=""
          for i in "${!matrix_versions[@]}"; do
            if [ "${matrix_versions[$i]}" == "${{ matrix.version }}" ]; then
              if [ $i -gt 0 ]; then
                prev_version="${matrix_versions[$i-1]}"
              fi
              break
            fi
          done

          if [ -z "$prev_version" ]; then
            echo "å½“å‰ç‰ˆæœ¬æ˜¯æœ€æ—©ç‰ˆæœ¬ï¼Œæ— éœ€ç­‰å¾…ï¼Œç›´æ¥å‘å¸ƒ ${{ matrix.version }}"
            exit 0
          fi

          echo "å½“å‰ç‰ˆæœ¬ä¹‹å‰çš„ Matrix ç‰ˆæœ¬: $prev_version"

          # å¾ªç¯ç­‰å¾…ï¼Œç›´åˆ°è¯¥ç‰ˆæœ¬ release å·²å­˜åœ¨
          until curl -s -f "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/v$prev_version" >/dev/null 2>&1; do
            echo "â³ ç­‰å¾…å‰ä¸€ä¸ªç‰ˆæœ¬ v$prev_version çš„ release åˆ›å»º..."
            sleep 5
          done

          echo "âœ… å‰ä¸€ä¸ªç‰ˆæœ¬ v$prev_version çš„ release å·²å­˜åœ¨ â€” å¯ä»¥å‘å¸ƒå½“å‰ç‰ˆæœ¬ ${{ matrix.version }}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: env.skip != 'true'
        with:
          tag_name: ${{ env.TAG }}
          name: 'Tailscale ${{ env.TAG }}'
          body: |
            ## ğŸš€ Tailscale ${{ env.TAG }} UPXå‹ç¼©ç‰ˆå‘å¸ƒ

            [![Downloads](https://img.shields.io/github/downloads/CH3NGYZ/small-tailscale-openwrt/${{ env.TAG }}/total)](https://github.com/CH3NGYZ/small-tailscale-openwrt/releases/${{ env.TAG }})

            ğŸ§© **æ”¯æŒæ¶æ„**ï¼š
            `${{ env.BUILD_PLATFORMS }}`

            âš™ï¸  **å†…å®¹è¯´æ˜**ï¼š
            - æ¯ä¸ªæ¶æ„åªç”Ÿæˆä¸€ä¸ªè”åˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡æ”¹åå³å¯åˆ†åˆ«ä½œä¸º`tailscale`ï¼ˆå‰å°ç¨‹åºï¼‰å’Œ`tailscaled`ï¼ˆåå°ç¨‹åºï¼‰è¿è¡Œã€‚
            - *æ³¨æ„ï¼šç”±äº UPX[ç›®å‰ä¸æ”¯æŒ, ä¹Ÿæ²¡æœ‰è®¡åˆ’æ”¯æŒ](https://github.com/upx/upx/issues/272#issuecomment-1250010942)`mips64`ä¸`mips64le`æ¶æ„, æ­¤releaseä¸­è¿™ä¸¤ä¸ªæ¶æ„çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸º`æœªå‹ç¼©`çš„çŠ¶æ€*

            ğŸ“„ **æ ¡éªŒæ–¹å¼**ï¼š
            æŠŠ tailscale-linux-* å’Œæ ¡éªŒæ–‡ä»¶æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ‰§è¡Œï¼š
            ```bash
            sha256sum -c SHA256SUMS.txt
            md5sum -c MD5SUMS.txt
            ```

            ğŸ”§  **å¿«é€Ÿå¯åŠ¨**ï¼š
            ```bash
            chmod +x /path/to/tailscaled-linux-amd64
            ln -s /path/to/tailscaled-linux-amd64 /usr/bin/tailscale
            ln -s /path/to/tailscaled-linux-amd64 /usr/bin/tailscaled
            tailscaled & # æœåŠ¡è¿›ç¨‹éœ€åå°è¿è¡Œ
            tailscale up # ç­‰å¾…æœåŠ¡è¿›ç¨‹è¿è¡Œå‡ ç§’ä¹‹åå†è¿è¡Œ(ç­‰å¾…æœåŠ¡è¿›ç¨‹ä¸tailscaleæœåŠ¡å™¨è¿æ¥)
            ```

            ğŸ“¦ **é™„å¸¦æ–‡ä»¶**ï¼š
            | æ–‡ä»¶å               | è¯´æ˜                  |
            |----------------------|-----------------------|
            | tailscaled-linux-ARCH    | ä¸åŒæ¶æ„å·²å‹ç¼©çš„å¯æ‰§è¡Œæ–‡ä»¶ |
            | tailscaled-linux-ARCH.build | ä¸åŒæ¶æ„æœªå‹ç¼©çš„å¯æ‰§è¡Œæ–‡ä»¶ |
            | SHA256SUMS.txt        | SHA256 æ ¡éªŒæ–‡ä»¶        |
            | MD5SUMS.txt           | MD5 æ ¡éªŒæ–‡ä»¶           |
            | version.txt           | å½“å‰ç‰ˆæœ¬          |

            ğŸ“œ **æ›´æ–°æ—¥å¿—**ï¼š
            [ç‚¹æ­¤æŸ¥çœ‹](https://tailscale.com/changelog)

          draft: false
          prerelease: false
          files: |
            ./build/tailscaled-*
            ./upx_compress/tailscaled-*
            version.txt
            SHA256SUMS.txt
            MD5SUMS.txt